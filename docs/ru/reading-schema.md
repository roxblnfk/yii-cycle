# Чтение схемы данных

Cycle ORM в своей работе полагается на схему,
представленную в виде объекта, реализующего интерфейс `\Cycle\ORM\SchemaInterface`.

Поскольку исходные данные для схемы представляют из себя массив определённой структуры,
мы можем хранить схему в кеше или в файле текстового формата.

Посмотреть используемую в вашем проекте схему вы можете с помощью консольной команды `cycle/schema`.

## Аннотации в сущностях

По умолчанию схема собирается на основе аннотаций сущностей вашего проекта. 

В процессе сборки схемы последовательно запускаются генераторы. Очерёдность запуска определяется в объекте,
реализующем интерфейс `SchemaConveyorInterface`. Вы можете внедрить свои генераторы в конвейер, определив их в
опции `cycle.common.generators` файла `config/params.php`.

Для получения схемы из конвейера используется фабрика `SchemaFromConveyorFactory`.

Процесс сборки схемы из аннотаций относительно ресурсоёмкий и может значительно влиять на производительность
приложения. Поэтому вкупе с аннотациями рекомендуется настроить кеширование схемы.

## Кеширование схемы

При использовании аннотаций работу с кешем обеспечивает фабрика `SchemaFromConveyorFactory`, которая по умолчанию уже
использует кеш. Для настройки кеша перейдите в файл `config/params.php` и установите `cacheEnabled` в значение `true`:

```php
# Файл config/params.php
return [
    # ...
    // Общие настройки Cycle
    'cycle.common' => [
        // Настройки схемы из аннотаций
        // Использовать кеш
        'cacheEnabled' => true,
        // Название ключа в кеше
        'cacheKey' => 'Cycle-ORM-Schema',
        // Список путей до папок с сущностями
        'entityPaths' => [
            # ...
        ],
        # ...
    ],
    # ...
];
```

## Схема в файле

Если вы желаете избежать использования аннотаций для описания схемы, можно описать её в PHP-файле.
Для этого вы можете использовать готовую фабрику `SchemaFromFileFactory`:

```php
# Файл config/common.php
use Yiisoft\Yii\Cycle\Factory\SchemaFromFileFactory;
return [
    # ...
    \Cycle\ORM\SchemaInterface::class => new SchemaFromFileFactory('@runtime/schema.php'),
    # ...
];
```

```php
# Файл runtime/common.php
use Cycle\ORM\Schema;
return [
   'user' => [
        Schema::MAPPER      => \Cycle\ORM\Mapper\Mapper::class,
        Schema::ENTITY      => \App\Entity\User::class,
        Schema::DATABASE    => 'default',
        Schema::TABLE       => 'users',
        Schema::PRIMARY_KEY => 'id',
        Schema::COLUMNS     => [
           'id'   => 'id',
           'name' => 'name'
        ],
        Schema::TYPECAST    => [
           'id' => 'int'
        ],
        Schema::RELATIONS   => []
    ]
];
```

При получении готовой схемы из файла не запускается конвейер с генераторами и не происходит сборки схемы.
Это сильно ускоряет работу, но при таком подходе миграции командой `migrate/generate`
генерироваться из готовой схемы не будут.

## Перенос схемы из аннотаций в файл

Для экспорта схемы в виде PHP можно воспользоваться консольной командой `cycle/schema/php`:

```bash
cycle/schema/php @runtime/schema.php
```

Псевдоним `@runtime` автоматически раскроется в соответствующее значение и схема запишется в указаный файл `schema.php`.

Убедитесь, что экспортированная схема не содержит ошибок, а затем назначьте на получение схемы из файла фабрику `SchemaFromFileFactory`:

```php
# Файл config/common.php
use Yiisoft\Yii\Cycle\Factory\SchemaFromFileFactory;
return [
    # ...
    \Cycle\ORM\SchemaInterface::class => new SchemaFromFileFactory('@runtime/schema.php'),
    # ...
];
```

После обновления кеша конфига (это можно сделать через `composer dump-autoload`) схема будет загружаться из PHP-файла
без исользования аннотаций сущностей.

Вы можете комбинировать оба способа описания схемы: при разработке используйте аннотации и генерируйте на их основе
миграции; для production переносите схему в файл.
