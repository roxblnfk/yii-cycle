# Получение схемы

Cycle ORM в своей работе полагается на схему,
представленную в виде объекта, реализующего интерфейс `\Cycle\ORM\SchemaInterface`.

Поскольку исходные данные для схемы представляют из себя массив определённой простой структуры,
мы можем без особого труда хранить схему в кеше или в файле текстового формата.

Посмотреть используемую в вашем проекте схему вы можете с помощью консольной команды `cycle/schema`

## Аннотации в сущностях

В базовой настройке пакета Yii-Cycle схема компилируется на основе аннотаций сущностей вашего проекта.

Процесс компиляции протекает через последовательные запуски генераторов.
Очерёдность запуска генераторов определяется в объекте, реализующем интерфейс `SchemaConveyorInterface`.
Вы можете внедрить свои генераторы в конвейер, определив их в
опции `cycle.common.generators` файла `config/params.php`.

Для получения схемы из конвейера используется фабрика `SchemaFromConveyorFactory`.

Если вы собираетесь продолжать использовать аннотации для описания схемы, то
учтите, что процесс компиляции относительно ресурсоёмкий и может значительно влиять на производительность
приложения. Поэтому вкупе с аннотациями рекомендуется настроить кеширование схемы.

## Кеширование схемы

Если вы используете аннотации для генерирования схемы, то работу с кешем обеспечивает фабрика
`SchemaFromConveyorFactory`, которая по умолчанию уже использует кеш.
Для настройки кеша перейдите в файл `config/params.php` и установите `cacheEnabled` в значение `true`:

```php
# Файл config/params.php
return [
    # ...
    // Общие настройки Cycle
    'cycle.common' => [
        // Настройки схемы из аннотаций
        // Использовать кеш
        'cacheEnabled' => true,
        // Название ключа в кеше
        'cacheKey' => 'Cycle-ORM-Schema',
        // Список путей до папок с сущностями
        'entityPaths' => [
            # ...
        ],
        # ...
    ],
    # ...
];
```

## Схема в файле

Если вы желаете избежать использования аннотаций для описания схемы, то самый простой
способ — описать схему в PHP-файле.

Для этих целей вы можете использовать готовую фабрику `SchemaFromFileFactory`, просто
назначьте её в контейнере на получение схемы:

```php
# Файл config/common.php
use Yiisoft\Yii\Cycle\Factory\SchemaFromFileFactory;
return [
    # ...
    \Cycle\ORM\SchemaInterface::class => new SchemaFromFileFactory('@runtime/schema.php'),
    # ...
];
```

```php
# Файл runtime/common.php
use Cycle\ORM\Schema;
return [
   'user' => [
        Schema::MAPPER      => \Cycle\ORM\Mapper\Mapper::class,
        Schema::ENTITY      => \App\Entity\User::class,
        Schema::DATABASE    => 'default',
        Schema::TABLE       => 'users',
        Schema::PRIMARY_KEY => 'id',
        Schema::COLUMNS     => [
           'id'   => 'id',
           'name' => 'name'
        ],
        Schema::TYPECAST    => [
           'id' => 'int'
        ],
        Schema::RELATIONS   => []
    ]
];
```

При получении готовой схемы из файла не используется конвейер с генераторами,
процесс компиляции не происходит. \
Это сильно ускоряет работу, но при таком подходе миграции командой `migrate/generate`
генерироваться из готовой схемы не будут.

## Перенос схемы из аннотаций в файл

Для представления схемы в виде php-разметки можно воспользоваться консольной
командой `cycle/schema/save`. \
Укажите первым параметром имя файла, чтобы перенести схему в файл. \
Например:

```bash
cycle/schema/save @runtime/schema.php
```

Псевдоним `@runtime` автоматически раскроется в соответствующее значение.

Убедитесь, что файл сохранился без ошибок, а затем назначьте в контейнере на получение
схемы из файла фабрику `SchemaFromFileFactory`:

```php
# Файл config/common.php
use Yiisoft\Yii\Cycle\Factory\SchemaFromFileFactory;
return [
    # ...
    \Cycle\ORM\SchemaInterface::class => new SchemaFromFileFactory('@runtime/schema.php'),
    # ...
];
```

После обновления кеша конфига схема будет загружаться из php-файла
без исользования аннотаций сущностей.

Вы можете комбинировать оба способа описания схемы: при разработке используйте аннотации и
генерируйте на их основе миграции; при переходе в боевой режим переносите схему в файл.
